import{a as G,r as x,c as z,w as A,b as r,F as D,f as E,e as c,z as K,t as v,B as Q,g as j,h as Y,n as R,k as d,A as J,d as b,o as X,p as Z,j as I}from"./index-D0FIH5Mc.js";import{_ as F}from"./index.vue_vue_type_script_setup_true_lang-CyVPFQV6.js";import{g as ee,c as te,b as le}from"./utils-Dxzpe7ps.js";import"./index-D1ypBbsW.js";const P={en:[{full:"Sunday",abbr:"Sun"},{full:"Monday",abbr:"Mon"},{full:"Tuesday",abbr:"Tue"},{full:"Wednesday",abbr:"Wed"},{full:"Thursday",abbr:"Thu"},{full:"Friday",abbr:"Fri"},{full:"Saturday",abbr:"Sat"}],zh_tw:[{full:"星期日",abbr:"日"},{full:"星期一",abbr:"一"},{full:"星期二",abbr:"二"},{full:"星期三",abbr:"三"},{full:"星期四",abbr:"四"},{full:"星期五",abbr:"五"},{full:"星期六",abbr:"六"}],zh_cn:[{full:"星期日",abbr:"日"},{full:"星期一",abbr:"一"},{full:"星期二",abbr:"二"},{full:"星期三",abbr:"三"},{full:"星期四",abbr:"四"},{full:"星期五",abbr:"五"},{full:"星期六",abbr:"六"}]},ae={class:"recur-time-selector flex flex-wrap"},se={class:"label__wrapper mr-2 mb-2 w-full lg:mb-0 lg:w-auto"},ne=["for"],de={key:0,class:"inline-block w-20 text-center"},re=["id","onUpdate:modelValue","disabled"],oe=["value","disabled"],ie=["id","onUpdate:modelValue","disabled"],ce=["value","disabled"],ue=G({name:"RecurTimeSelector",__name:"index",props:{closeAllSelector:{type:Boolean,default:!1},weekStartDay:{default:0},timeSlotDuration:{default:30},disabledDays:{default:()=>[]},locale:{default:"zh_tw"},isAbbrText:{type:Boolean,default:!1},selectClass:{default:"w-full truncate rounded border border-[#ccc] py-2 pl-2 pr-8 focus:border-blue-300 focus:ring-blue-300 min-w-32"},optionClass:{default:""}},emits:["change"],setup(y,{emit:T}){const n=y,w=T,g=x([]),h=z(()=>{const s=n.weekStartDay;return[...g.value.slice(s),...g.value.slice(0,s)]}),S=()=>{g.value=Array.from({length:7},(s,a)=>{const t=n.disabledDays.includes(a);return{selectedStartTime:"",selectedEndTime:"",value:a.toString(),text:n.isAbbrText?P[n.locale]?.[a].abbr:P[n.locale]?.[a].full,isToggle:!1,isDisableDay:t,startTimeOptions:t?[]:[{start:"",end:"",weekday:""},...ee({timeSlotDuration:n.timeSlotDuration,weekday:a.toString()})],endTimeOptions:t?[]:[{start:"",end:"",weekday:""}]}})},p=()=>{h.value.forEach(s=>{A(()=>s.selectedStartTime,()=>{s.selectedEndTime="",s.endTimeOptions=[{start:"",end:"",weekday:""},...s.startTimeOptions.filter(a=>s.selectedStartTime?a.start>=s.selectedStartTime:!1)]},{deep:!0})})};return A(()=>n.disabledDays,()=>{S(),p()},{deep:!0,immediate:!0}),A(()=>h.value,s=>{const a=s.filter(t=>t.isToggle).map(t=>({selectedStartTime:t.selectedStartTime,selectedEndTime:t.selectedEndTime,weekday:t.value,text:t.text,isValid:!!t.selectedStartTime&&!!t.selectedEndTime}));w("change",a)},{deep:!0}),(s,a)=>(d(),r("div",ae,[(d(!0),r(D,null,E(h.value,(t,i)=>(d(),r("div",{key:i,class:"my-4 flex w-full flex-wrap items-center px-4 lg:my-2 lg:justify-center lg:px-0"},[c("div",se,[c("label",{for:`toggle-${i}`,class:"mx-2"},v(t.text),9,ne),t.isDisableDay?(d(),r("span",de,[Q(s.$slots,"disable-day-text",{},()=>[a[0]||(a[0]=J("無適用時段",-1))])])):(d(),K(F,{key:1,id:`toggle-${i}`,value:t.isToggle,"onUpdate:value":u=>t.isToggle=u,disabled:y.closeAllSelector,class:"w-20","switch-on-color":"#3A7DC9"},null,8,["id","value","onUpdate:value","disabled"]))]),c("div",{class:R(["start-options__wrapper w-1/2 px-2 lg:w-auto",{hidden:!t.isToggle}])},[j(c("select",{id:`start-${i}`,"onUpdate:modelValue":u=>t.selectedStartTime=u,disabled:!t.isToggle||y.closeAllSelector,class:R([n.selectClass,t.selectedStartTime.length===0?"border-red-500":""])},[(d(!0),r(D,null,E(t.startTimeOptions,(u,o)=>(d(),r("option",{key:`start-${i}-${o}`,value:u.start,class:R([n.optionClass]),disabled:u.start===""},v(u.start===""?s.$t("please-select-start-time"):u.start),11,oe))),128))],10,re),[[Y,t.selectedStartTime]])],2),c("div",{class:R(["end-options__wrapper w-1/2 pl-2 lg:w-auto",{hidden:!t.isToggle}])},[j(c("select",{id:`end-${i}`,"onUpdate:modelValue":u=>t.selectedEndTime=u,disabled:!t.isToggle||y.closeAllSelector,class:R([n.selectClass,t.selectedEndTime.length===0?"border-red-500":""])},[(d(!0),r(D,null,E(t.endTimeOptions,(u,o)=>(d(),r("option",{key:`end-${i}-${o}`,value:u.end,class:R([n.optionClass]),disabled:u.end===""},v(u.end===""?s.$t("please-select-end-time"):u.end),11,ce))),128))],10,ie),[[Y,t.selectedEndTime]])],2)]))),128))]))}});function N({startTime:y,endTime:T,date:n,slotStart:w,slotEnd:g,slotDate:h,dateFormat:S="YYYY-MM-DD",timeFormat:p="HH:mm"}){const s=b(`${n} ${y}`,`${S} ${p}`);let a=b(`${n} ${T}`,`${S} ${p}`);T==="00:00"&&a.isBefore(s)&&(a=a.add(1,"day"));const t=b(`${h} ${w}`,`${S} ${p}`);let i=b(`${h} ${g}`,`${S} ${p}`);return g==="00:00"&&i.isBefore(t)&&(i=i.add(1,"day")),s.isBefore(i)&&a.isAfter(t)}const fe=async({selectedStartDate:y,selectedEndDate:T,dateFormatStr:n="YYYY-MM-DD",selectedRecurTimeResult:w=[],usedTimeSlots:g=[]})=>{const h=b(y,n),S=b(T,n),p=b().startOf("day"),s=[],a=[],t=[];let i=!1;const u=g.reduce((o,V)=>{const _=b(V.date).format(n);return o[_]||(o[_]=[]),o[_].push(V),o},{});for(let o=h;o.isSameOrBefore(S);o=o.add(1,"day")){const V=o.day(),_=o.format(n),$=w.find(l=>parseInt(l.weekday)===V);if(!$)continue;if(b(`${_} ${$.selectedStartTime}`,`${n} HH:mm`).isBefore(b(),"minute")){i=!0;const l={...$,date:_};t.push(l);continue}let H=u[_]||[];if(o.isSame(p)){const l=b();H=H.filter(e=>b(`${e.date} ${e.endTime}`,`${n} HH:mm`).isSameOrAfter(l))}let M=!1;const B={selectedStartTime:$.selectedStartTime,selectedEndTime:$.selectedEndTime,text:$.text,weekday:$.weekday,isValid:$.isValid},L={...B,date:_},m={...B,conflictDate:_,usedSlot:H,conflictSlot:[],startOptions:[],endOptions:[],endOptionsRaw:{},finalSelectedStartTime:"",finalSelectedEndTime:""};H.forEach(l=>{N({startTime:$.selectedStartTime,endTime:$.selectedEndTime,date:o.format(n),slotStart:l.startTime,slotEnd:l.endTime,slotDate:l.date})&&(M=!0,m.conflictSlot?.push(l))}),M?a.push(m):s.push(L)}return{hasConflict:a.length>0,hasSelectionExpired:i,conflictList:a,expiredList:t,validList:s}},me=({conflictItem:y,timeSlotDuration:T=30,dateFormat:n="YYYY-MM-DD"})=>{let w=[];const g={},h=b(),S=b(y.conflictDate).format(n)===h.format(n);let p=b(`${y.conflictDate} 00:00`,`${n} HH:mm`);const s=b(`${y.conflictDate} 24:00`,`${n} HH:mm`);for(;p.isBefore(s);)y.usedSlot.some(t=>N({startTime:p.format("HH:mm"),endTime:p.add(T,"minute").format("HH:mm"),date:y.conflictDate,slotStart:t.startTime,slotEnd:t.endTime,slotDate:t.date}))||w.push({date:y.conflictDate,label:p.format("HH:mm"),value:p.format("HH:mm")}),p=p.add(T,"minute");return S&&(w=w.filter(a=>b(`${a.date} ${a.value}`,`${n} HH:mm`).isSameOrAfter(h,"minute"))),w.forEach(a=>{let t=b(`${y.conflictDate} ${a.value}`,`${n} HH:mm`).add(T,"minute");const i=[];for(;t.isSameOrBefore(s);)y.usedSlot.some(o=>N({startTime:a.value,endTime:t.format("HH:mm"),date:y.conflictDate,slotStart:o.startTime,slotEnd:o.endTime,slotDate:o.date}))||i.push({date:y.conflictDate,label:t.format("HH:mm")==="00:00"?"24:00":t.format("HH:mm"),value:t.format("HH:mm")}),t=t.add(T,"minute");g[a.value]=i.length>0?[{label:"結束",disabled:!0,value:"",date:""},...i]:[]}),w.unshift({label:"開始",disabled:!0,value:"",date:""},{label:"不預約",value:"no-booked",date:""}),{availableStartTimes:w,availableEndTimes:g}},pe={class:"mx-auto w-full"},ye={class:"flex items-center justify-center"},be={class:"m-2"},Te={class:"my-1 flex flex-wrap justify-center"},ve={class:"my-1 flex flex-wrap justify-center"},he={class:"mb-2 w-full text-center"},Se={class:"mb-2 w-full text-center"},we={class:"flex items-center justify-center"},ge={class:"m-2"},De={class:"my-1 flex flex-wrap justify-center"},_e=["disabled"],$e={class:"my-1 flex flex-wrap justify-center"},ke={key:0,class:"w-full text-center"},xe={key:0,class:"w-full text-center"},Ee={key:1,class:"w-full text-center"},He=["onUpdate:modelValue"],Ce=["value","disabled"],Re=["onUpdate:modelValue"],Ve=["value","disabled"],Oe={key:0,class:"w-full text-center"},je={key:1,class:"w-full text-center"},Ae={key:2,class:"w-full text-center"},C="YYYY-MM-DD",q=30,Le=G({__name:"RecurTimeSelector",setup(y){const T=b(),n=T.subtract(1,"day"),w=T.add(1,"day"),g=T.add(1,"month"),h=x(!1),S=x([]),p=x(!1),s=x(""),a=x([]),t=async()=>{await new Promise(e=>setTimeout(e,500));const m=[],l=e=>{const f=m.filter(W=>W.date===e.format(C)),{start:k,end:O}=le(f);m.push({date:e.format(C),start:k,end:O,type:"used"})};l(n);for(let e=0;e<2;e++)l(T);for(let e=0;e<2;e++)l(w);for(let e=0;e<3;e++)l(g);return m.map(e=>({startTime:e.start,endTime:e.end,date:e.date})).sort((e,f)=>{const k=e.date,O=f.date;return k!==O?k.localeCompare(O):e.startTime.localeCompare(f.startTime)})},i=x(T.format(C)),u=x(T.format(C)),o=x([]),V=z(()=>o.value.every(m=>m.isValid)),_=z(()=>te({startDate:i.value,endDate:u.value})?.exclude||[]),$=m=>{o.value=m},U=()=>{h.value=!1,p.value=!1,s.value="",M()},H=()=>{h.value=!1,p.value=!1,s.value="",M()},M=()=>{S.value=[]},B=async()=>{if(h.value=!1,o.value.length===0)return alert("請檢查是否有選擇內容");if(!o.value.every(f=>f.isValid===!0))return alert("請檢查內容是否有誤");if(b(i.value,C).isBefore(T,"day"))return alert("開始日期不可早於今天");const{hasSelectionExpired:l,conflictList:e}=await fe({selectedStartDate:i.value,selectedEndDate:u.value,selectedRecurTimeResult:o.value,usedTimeSlots:a.value,dateFormatStr:C});if(l){s.value="開始時間有包含過去的時間段",p.value=!0;return}else s.value="";for(let f=0;f<e.length;f++){const k=e[f],{availableStartTimes:O,availableEndTimes:W}=me({conflictItem:k,timeSlotDuration:q,dateFormat:C});e[f].startOptions=O,e[f].endOptionsRaw=W}S.value=e,L(),h.value=!0,p.value=!0},L=()=>{S.value.forEach(m=>{A(()=>m.finalSelectedStartTime,l=>{m.finalSelectedEndTime="",m.endOptions=m.endOptionsRaw[l]||[]},{deep:!0})})};return X(async()=>{const m=await t();a.value=m}),A(i,m=>{m&&U()}),A(u,m=>{m&&H()}),(m,l)=>(d(),r("div",pe,[c("div",ye,[c("h3",be,v(m.$t("used-time-slots")),1),c("ul",null,[(d(!0),r(D,null,E(a.value,e=>(d(),r("li",{key:e.startTime},[c("p",null,v(e.date)+" "+v(e.startTime)+" ~ "+v(e.endTime),1)]))),128))])]),c("div",Te,[l[2]||(l[2]=c("p",{class:"mb-2 w-full text-center"},"選取的週期時間",-1)),(d(!0),r(D,null,E(o.value,e=>(d(),r("p",{key:e.weekday,class:R(["mb-2 w-full text-center",{"text-red-500":!e.isValid}])},v(e.weekday)+": "+v(e.selectedStartTime)+" ~ "+v(e.selectedEndTime),3))),128))]),c("div",ve,[c("p",he,"限制選取日: "+v(_.value),1),l[3]||(l[3]=c("p",{class:"mb-2 w-full text-center"},"0: Sun, 1: Mon, ...etc.",-1)),c("p",Se,"選取內容無漏填: "+v(V.value),1)]),c("div",we,[c("div",ge,[l[4]||(l[4]=c("label",{for:"start-date-picker",class:"mx-2"},"開始日期",-1)),j(c("input",{id:"start-date-picker","onUpdate:modelValue":l[0]||(l[0]=e=>i.value=e),type:"date",onChange:U},null,544),[[I,i.value]]),l[5]||(l[5]=c("label",{for:"end-date-picker",class:"mx-2"},"結束日期",-1)),j(c("input",{id:"end-date-picker","onUpdate:modelValue":l[1]||(l[1]=e=>u.value=e),type:"date",onChange:H},null,544),[[I,u.value]])])]),Z(ue,{"close-all-selector":i.value===""||u.value===""||h.value,"week-start-day":1,"disabled-days":_.value,"time-slot-duration":q,class:"flex justify-center",onChange:$},null,8,["close-all-selector","disabled-days"]),c("div",De,[c("button",{class:"send-form rounded bg-black px-4 py-2 text-white",disabled:h.value,onClick:B}," 送出 ",8,_e)]),c("div",$e,[!p.value&&(i.value===""||u.value==="")?(d(),r("p",ke,"無檢查結果")):(d(),r(D,{key:1},[p.value?(d(),r(D,{key:0},[S.value.length===0?(d(),r(D,{key:0},[s.value?(d(),r("p",Ee,v(s.value),1)):(d(),r("p",xe,"無衝突，可打 api"))],64)):(d(),r(D,{key:1},[l[6]||(l[6]=c("p",{class:"w-full text-center"},"有衝突，請檢查以下選項",-1)),(d(!0),r(D,null,E(S.value,e=>(d(),r("p",{key:e.weekday,class:"mb-2 w-full text-center"},[J(v(e.conflictDate)+" - "+v(e.weekday)+": "+v(e.selectedStartTime)+" ~ "+v(e.selectedEndTime)+" ",1),j(c("select",{"onUpdate:modelValue":f=>e.finalSelectedStartTime=f},[(d(!0),r(D,null,E(e.startOptions,(f,k)=>(d(),r("option",{key:`start-${e.weekday}-${k}`,value:f.value,disabled:f.disabled},v(f.label),9,Ce))),128))],8,He),[[Y,e.finalSelectedStartTime]]),j(c("select",{"onUpdate:modelValue":f=>e.finalSelectedEndTime=f},[(d(!0),r(D,null,E(e.endOptions,(f,k)=>(d(),r("option",{key:`end-${e.weekday}-${k}`,value:f.value,disabled:f.disabled},v(f.label),9,Ve))),128))],8,Re),[[Y,e.finalSelectedEndTime]])]))),128))],64))],64)):(d(),r(D,{key:1},[o.value.length===0?(d(),r("p",Oe,"尚無選擇結果")):o.value.some(e=>e.isValid===!1)?(d(),r("p",je," 請檢查選取內容是否都已選取 ")):(d(),r("p",Ae,"請點選「送出」來檢查"))],64))],64))])]))}});export{Le as default};
